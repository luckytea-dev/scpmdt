<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SCP Foundation - MDT (GitHub Version)</title>
    <style>
        * { box-sizing: border-box; font-family: 'Courier New', monospace; }
        body { margin: 0; background: #0a0a0a; color: #dcdcdc; overflow: hidden; height: 100vh; }

        /* UI THEME */
        #topbar { height: 60px; background: #111; border-bottom: 2px solid #444; display: flex; align-items: center; padding: 0 25px; letter-spacing: 1px; z-index: 1000; position: relative; }
        .header-restricted { color: #f44; font-weight: bold; margin-right: 15px; }
        .header-site { color: #888; border-left: 1px solid #444; padding-left: 15px; }
        .header-user-info { margin-left: auto; font-size: 13px; color: #bbb; background: #1a1a1a; padding: 5px 15px; border: 1px solid #333; }

        #sidebar { position: absolute; top: 60px; left: 0; width: 220px; height: calc(100vh - 60px); background: #111; border-right: 2px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 500; }
        .sidebar-btn { padding: 12px; border: 1px solid #444; background: #1a1a1a; color: #bbb; font-size: 11px; cursor: pointer; text-align: left; text-transform: uppercase; transition: 0.2s; }
        .sidebar-btn:hover { background: #333; color: #fff; border-color: #666; }
        .admin-only { display: none; border-color: #600 !important; color: #f44 !important; }

        /* WINDOWS SYSTEM */
        .window { position: absolute; background: #0f0f0f; border: 1px solid #333; display: none; flex-direction: column; width: 850px; height: 600px; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.9); top: 100px; left: 250px; }
        .titlebar { background: #222; padding: 10px 15px; font-size: 13px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; cursor: move; color: #fff; user-select: none; }
        .titlebar button { background: #400; border: none; color: #fff; cursor: pointer; padding: 4px 10px; }
        .content { padding: 20px; font-size: 14px; overflow-y: auto; flex: 1; }

        /* MESSAGERIE */
        .chat-container { display: flex; height: 100%; padding: 0; }
        #chan-list { width: 200px; border-right: 1px solid #333; padding: 15px; overflow-y: auto; background: #0d0d0d; }
        #chat-main { flex: 1; display: flex; flex-direction: column; padding: 15px; }
        .chat-log { flex: 1; background: #000; border: 1px solid #222; padding: 10px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; color: #0f0; }

        /* INPUTS */
        .input-scp { background: #111; border: 1px solid #444; color: #fff; padding: 10px; width: 100%; margin-bottom: 10px; outline: none; }
        .input-scp:focus { border-color: #f44; }

        #login-overlay { position: fixed; inset: 0; background: #050505; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        
        /* REPORT VIEW */
        .report-paper { background: #fff; color: #000; padding: 40px; min-height: 100%; font-family: 'Times New Roman', serif; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div style="border: 1px solid #333; padding: 40px; width: 400px; background: #0a0a0a; text-align: center;">
        <img src="https://scp-wiki.wdfiles.com/local--files/component%3Atheme/logo.png" style="width:80px; filter:invert(1); margin-bottom:20px;">
        <h2 style="letter-spacing: 3px;">AUTHENTIFICATION</h2>
        <input type="text" id="user-id" class="input-scp" style="text-align:center" placeholder="ID PERSONNEL">
        <input type="password" id="user-pass" class="input-scp" style="text-align:center" placeholder="CLÉ DE SÉCURITÉ">
        <button id="login-btn" class="sidebar-btn" style="width:100%;" onclick="checkLogin()">INITIALISER CONNEXION</button>
        <div id="login-msg" style="color:#f44; margin-top:15px; font-size: 12px;"></div>
    </div>
</div>

<div id="topbar">
    <span class="header-restricted">[NIVEAU SECRET DÉFENSE]</span>
    <span class="header-site">BASE DE DONNÉES SCIPNET - SITE-01</span>
    <div class="header-user-info">AGENT: <span id="display-id">---</span> | ACCRÉDITATION: <span id="display-lvl">---</span></div>
</div>

<div id="sidebar">
    <div class="sidebar-btn" data-open="profile">Dossier Personnel</div>
    <div class="sidebar-btn" data-open="documents">Archives SCP</div>
    <div class="sidebar-btn" data-open="creator" style="color: #0f0;">Créer Rapport</div>
    <div class="sidebar-btn" data-open="comms">Communications</div>
    <div class="sidebar-btn admin-only" data-open="admin-agents">O5 - Gestion Personnel</div>
    <div class="sidebar-btn" onclick="location.reload()" style="margin-top:auto; color:#f44; border-color:#400;">DÉCONNEXION</div>
</div>

<div id="win-profile" class="window"><div class="titlebar"><span>PROFIL AGENT</span><button data-close="win-profile">X</button></div><div class="content" id="prof-data"></div></div>

<div id="win-documents" class="window"><div class="titlebar"><span>ARCHIVES SÉCURISÉES</span><button data-close="win-documents">X</button></div><div class="content" id="archive-list"></div></div>

<div id="win-comms" class="window">
    <div class="titlebar"><span>RÉSEAU DE COMMUNICATION</span><button data-close="win-comms">X</button></div>
    <div class="content chat-container">
        <div id="chan-list"></div>
        <div id="chat-main">
            <div id="chat-title" style="color:#f44; margin-bottom:5px;">CANAL: GÉNÉRAL</div>
            <div id="chat-log" class="chat-log"></div>
            <div style="display:flex; gap:5px;">
                <input id="chat-in" class="input-scp" placeholder="Entrer message..." autocomplete="off">
                <button class="sidebar-btn" style="height:40px;" onclick="sendMsg()">ENVOYER</button>
            </div>
        </div>
    </div>
</div>

<div id="win-creator" class="window">
    <div class="titlebar"><span>ÉDITEUR DE RAPPORT</span><button data-close="win-creator">X</button></div>
    <div class="content">
        <input id="c-item" class="input-scp" placeholder="Désignation (ex: SCP-001)">
        <input id="c-lvl" type="number" class="input-scp" placeholder="Niveau requis (1-5)">
        <textarea id="c-desc" class="input-scp" style="height:200px;" placeholder="Description et procédures..."></textarea>
        <button class="sidebar-btn" style="width:100%; border-color:#0f0;" onclick="saveReport()">TRANSMETTRE À LA BASE DE DONNÉES</button>
    </div>
</div>

<div id="win-view-report" class="window"><div class="titlebar"><span>LECTURE ARCHIVE</span><button data-close="win-view-report">X</button></div><div class="content" id="report-viewer" style="background:#222;"></div></div>

<div id="win-admin-agents" class="window">
    <div class="titlebar"><span>O5 - CONTRÔLE DES ACCÈS</span><button data-close="win-admin-agents">X</button></div>
    <div class="content">
        <div style="background:#111; padding:15px; border:1px solid #444; margin-bottom:15px;">
            <input id="adm-id" class="input-scp" placeholder="ID (ex: AGENT-SMITH)">
            <input id="adm-pass" class="input-scp" placeholder="Clé de sécurité">
            <select id="adm-lvl" class="input-scp"><option value="1">Niveau 1</option><option value="2">Niveau 2</option><option value="3">Niveau 3</option><option value="4">Niveau 4</option><option value="5">Niveau 5 (O5)</option></select>
            <button onclick="adminSave()" class="sidebar-btn" style="width:100%;">ENREGISTRER AGENT</button>
        </div>
        <table style="width:100%; text-align:left;" id="agent-table"></table>
    </div>
</div>

<script>
const BIN_ID = "695497c343b1c97be90f96ce";
const MASTER_KEY = "$2a$10$eHN8MXmITN.koPG.UViRYutQVeTRQWfLWZuBlTPvHPuhXXiG1snfq";
const WEBHOOK = "https://discordapp.com/api/webhooks/1455365063895548071/mV0Apst2lfm5E50Vyu6W2lhg9G9C1Ma9tVW22yABGkQ7VWSItGErO7VUdFYlD3HXWTgX";

let agents = {};
let reports = [];
let messages = [];
let currentUser = null;
let activeChan = "GÉNÉRAL";

async function syncCloud(isSaving = false) {
    const headers = { "X-Master-Key": MASTER_KEY, "Content-Type": "application/json", "X-Bin-Versioning": "false" };
    try {
        if (isSaving) {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT', headers: headers,
                body: JSON.stringify({ agents, reports, messages })
            });
        } else {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: headers });
            const data = await res.json();
            agents = data.record.agents || {"O5-1": {pass:"ROOT", level:5}};
            reports = data.record.reports || [];
            messages = data.record.messages || [];
        }
    } catch (e) { console.error("Erreur Sync:", e); }
}

async function checkLogin() {
    const id = document.getElementById('user-id').value.toUpperCase();
    const ps = document.getElementById('user-pass').value;
    document.getElementById('login-btn').textContent = "SYNCHRONISATION...";
    
    await syncCloud();
    if(agents[id] && agents[id].pass === ps) {
        currentUser = { ...agents[id], id: id };
        document.getElementById('login-overlay').style.display = 'none';
        init();
    } else {
        document.getElementById('login-msg').textContent = "ACCÈS REFUSÉ : IDENTIFIANTS INCORRECTS";
        document.getElementById('login-btn').textContent = "RÉESSAYER";
    }
}

function init() {
    document.getElementById('display-id').textContent = currentUser.id;
    document.getElementById('display-lvl').textContent = "NIVEAU " + currentUser.level;
    if(currentUser.level >= 5) document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
    
    updateUI();
    // BOUCLE ACTUALISATION AUTO (5 secondes)
    setInterval(async () => {
        await syncCloud(false);
        updateUI();
    }, 5000);
}

function updateUI() {
    renderArchives();
    refreshAgents();
    loadMsgs();
    renderChans();
}

function renderChans() {
    const l = document.getElementById('chan-list');
    l.innerHTML = "<b>CANAUX</b><hr>";
    ["GÉNÉRAL", "SÉCURITÉ"].forEach(c => l.innerHTML += `<div class="sidebar-btn" onclick="activeChan='${c}'; loadMsgs();">${c}</div>`);
}

async function sendMsg() {
    const i = document.getElementById('chat-in');
    if(!i.value) return;
    messages.push({ chan: activeChan, sender: currentUser.id, text: i.value });
    await syncCloud(true);
    i.value = ""; loadMsgs();
}

function loadMsgs() {
    const log = document.getElementById('chat-log'); log.innerHTML = "";
    document.getElementById('chat-title').textContent = "CANAL: " + activeChan;
    messages.filter(m => m.chan === activeChan).forEach(m => {
        log.innerHTML += `<div><b>${m.sender}:</b> ${m.text}</div>`;
    });
    log.scrollTop = log.scrollHeight;
}

async function saveReport() {
    reports.push({ 
        item: document.getElementById('c-item').value, 
        lvl: document.getElementById('c-lvl').value, 
        desc: document.getElementById('c-desc').value 
    });
    await syncCloud(true);
    document.getElementById('win-creator').style.display = 'none';
    renderArchives();
}

function renderArchives() {
    const l = document.getElementById('archive-list'); l.innerHTML = "";
    reports.forEach((r, i) => {
        l.innerHTML += `<div style="border:1px solid #333; padding:10px; margin-bottom:5px; background:#111; display:flex; justify-content:space-between;">
            <span>${r.item} [L${r.lvl}]</span>
            <button class="sidebar-btn" onclick="viewReport(${i})">LIRE</button>
        </div>`;
    });
}

function viewReport(i) {
    const r = reports[i];
    if(currentUser.level < r.lvl) return alert("ACCRÉDITATION INSUFFISANTE");
    document.getElementById('report-viewer').innerHTML = `<div class="report-paper"><h1>${r.item}</h1><p>${r.desc}</p></div>`;
    document.getElementById('win-view-report').style.display = 'flex';
}

async function adminSave() {
    const id = document.getElementById('adm-id').value.toUpperCase();
    agents[id] = { pass: document.getElementById('adm-pass').value, level: parseInt(document.getElementById('adm-lvl').value) };
    await syncCloud(true); refreshAgents();
}

function refreshAgents() {
    const t = document.getElementById('agent-table');
    t.innerHTML = "<tr><th>AGENT</th><th>NIVEAU</th></tr>";
    for(let id in agents) t.innerHTML += `<tr><td>${id}</td><td>L${agents[id].level}</td></tr>`;
}

// DRAG & DROP FENÊTRES
let zIndex = 100;
document.querySelectorAll("[data-open]").forEach(btn => btn.onclick = () => {
    const win = document.getElementById("win-" + btn.dataset.open);
    win.style.display = "flex"; win.style.zIndex = ++zIndex;
});
document.querySelectorAll("[data-close]").forEach(btn => btn.onclick = () => document.getElementById(btn.dataset.close).style.display = "none");
</script>
</body>
</html>
